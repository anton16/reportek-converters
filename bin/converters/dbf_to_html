#!/usr/bin/env python
# -*- coding: utf-8 -*-
import argparse
import sys
import dbf
import tempfile
import encodings
from jinja2 import Template
from BeautifulSoup import BeautifulSoup as bs

if __name__ == '__main__':
    parser = argparse.ArgumentParser(
                description='Convert dbf file to html.')
    parser.add_argument(
        'src_file',
        metavar='src-file',
        help='path to dbf file')
    params = parser.parse_args()

    #dbf module needs a file with extension
    with tempfile.NamedTemporaryFile(suffix=".dbf", mode="w+b") as tmp:
        data = open(params.src_file, 'rb').read()
        tmp.file.write(data)
        tmp.file.flush()
        table = dbf.Table(tmp.name).open()
        table.use_deleted = False
        attrs = table.field_names
        records = []
        for record in table:
            tmp = []
            for attr in attrs:
                try:
                    value = record[attr]
                except UnicodeDecodeError as exp:
                    table._meta.decoder = encodings.codecs.latin_1_decode
                    value = record[attr]
                assert(isinstance(value, unicode))
                tmp.append(value.strip())
            records.append(tmp)

        template = Template(
                    '<!DOCTYPE html>'
                    '<html lang="en">'
                       '<head>'
                         '<meta charset="utf-8">'
                         '<title>Display as HTML</title>'
                       '</head>'
                       '<body>'
                         '<table border="1">'
                           '<tr>'
                               '{% for name in field_names %}'
                                   '<th>{{ name }}</th>'
                               '{% endfor %}'
                           '</tr>'
                             '{% for row in records %}'
                               '<tr>'
                                 '{% for value in row %}'
                                   '<td>{{ value }}</td>'
                                 '{% endfor %}'
                               '</tr>'
                             '{% endfor %}'
                         '</table>'
                       '</body>'
                    '</html>')
        output = template.render(field_names=attrs, records=records)
        pretty_output = bs(output).prettify()
        sys.stdout.write(pretty_output)
